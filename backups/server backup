import cv2

from flask import Flask, render_template, Response, request, jsonify

import pygame

import os



app = Flask(__name__)



# ==========================================

# 1. éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–

# ==========================================

try:

pygame.mixer.init()

# å¢åŠ é¢‘é“æ•°é‡ï¼Œç¡®ä¿èƒŒæ™¯éŸ³+å¿ƒè·³+å¤šä¸ªå›å¿†éŸ³æ•ˆèƒ½åŒæ—¶æ’­æ”¾

pygame.mixer.set_num_channels(32)

print("âœ… Pygame Audio Mixer Initialized")

except Exception as e:

print(f"âŒ Audio Init Failed: {e}")



sounds = {}

memory_sounds = {} # ä¸“é—¨å­˜å‚¨å›å¿†éŸ³æ•ˆ



def load_sounds():

"""åŠ è½½éŸ³æ•ˆæ–‡ä»¶"""

try:

# 1. åŸºç¡€éŸ³æ•ˆ

sounds['heartbeat'] = pygame.mixer.Sound('static/heartbeat.mp3')

sounds['flatline'] = pygame.mixer.Sound('static/flatline.mp3')

sounds['underwater'] = pygame.mixer.Sound('static/underwater_muffled.mp3')


# 2. å›å¿†éŸ³æ•ˆ (mem1.mp3 ~ mem10.mp3)

for i in range(1, 11):

filename = f'static/mem/{i}.mp3'

if os.path.exists(filename):

memory_sounds[i] = pygame.mixer.Sound(filename)

# é»˜è®¤éŸ³é‡å¯ä»¥ç¨å¾®å¤§ä¸€ç‚¹ï¼Œä¾é fadeæ§åˆ¶

memory_sounds[i].set_volume(1.0)

print(f" - Loaded memory sound: {filename}")


# åˆå§‹çŠ¶æ€ï¼šé—·éŸ³é™éŸ³å¾ªç¯ï¼Œå¿ƒè·³å¤§å£°

sounds['underwater'].set_volume(0.0)

sounds['underwater'].play(loops=-1)

sounds['heartbeat'].set_volume(1.0)


print("âœ… Sounds loaded successfully")

except Exception as e:

print(f"âš ï¸ Warning: Could not load sound files. Details: {e}")



load_sounds()



# ==========================================

# 2. è§†å£æ§åˆ¶ (ä¿æŒä¸å˜)

# ==========================================

view_state = {'x': 0.6, 'y': 0.5}



@app.after_request

def add_header(response):

response.headers['Access-Control-Allow-Origin'] = '*'

response.headers['Cache-Control'] = 'no-store'

return response



@app.route('/control', methods=['POST'])

def control_view():

data = request.json

global view_state

if 'x' in data: view_state['x'] = max(0.0, min(1.0, float(data['x'])))

if 'y' in data: view_state['y'] = max(0.0, min(1.0, float(data['y'])))

return jsonify(view_state)



# ==========================================

# 3. è§†é¢‘æµé€»è¾‘ (ä¿æŒä¸å˜)

# ==========================================

def generate_frames():

# æ³¨æ„ï¼šç¡®ä¿è¿™é‡Œçš„ Index 2 æ˜¯ä½ çš„é‡‡é›†å¡

camera = cv2.VideoCapture(2)

camera.set(cv2.CAP_PROP_FRAME_WIDTH, 1280)

camera.set(cv2.CAP_PROP_FRAME_HEIGHT, 720)

camera.set(cv2.CAP_PROP_FPS, 60)

camera.set(cv2.CAP_PROP_BUFFERSIZE, 1)



while True:

success, frame = camera.read()

if not success: break

else:

frame = cv2.flip(frame, 1)

h, w = frame.shape[:2]

crop_w, crop_h = int(w * 0.5), int(h * 0.5)

max_x, max_y = w - crop_w, h - crop_h

sx = int(view_state['x'] * max_x)

sy = int(view_state['y'] * max_y)

sx = max(0, min(sx, max_x))

sy = max(0, min(sy, max_y))

cropped = frame[sy:sy+crop_h, sx:sx+crop_w]

frame = cv2.resize(cropped, (w, h), interpolation=cv2.INTER_LINEAR)

ret, buffer = cv2.imencode('.jpg', frame, [int(cv2.IMWRITE_JPEG_QUALITY), 80])

yield (b'--frame\r\nContent-Type: image/jpeg\r\n\r\n' + buffer.tobytes() + b'\r\n')



# ==========================================

# 4. è·¯ç”±å®šä¹‰

# ==========================================

@app.route('/')

def index():

return render_template('index.html')



@app.route('/video_feed')

def video_feed():

return Response(generate_frames(), mimetype='multipart/x-mixed-replace; boundary=frame')



# --- éŸ³æ•ˆæ§åˆ¶æ¥å£ (ä¿®æ”¹éƒ¨åˆ†) ---

@app.route('/trigger_effect', methods=['POST'])

def trigger_effect():

data = request.json

action = data.get('action')

# print(f"ğŸ›ï¸ Audio Trigger: {action}") # debugç”¨ï¼Œå¤ªé¢‘ç¹å¯ä»¥æ³¨é‡Šæ‰



if 'heartbeat' not in sounds:

return jsonify({"status": "error", "msg": "Sounds not loaded"})



# --- åœºæ™¯åˆ‡æ¢ ---

if action == 'mode_void':

sounds['heartbeat'].fadeout(2000)

sounds['underwater'].set_volume(1.0)

sounds['flatline'].play()

# è¿›å…¥è™šç©ºæ—¶ï¼Œåœæ­¢æ‰€æœ‰å›å¿†å£°éŸ³

for s in memory_sounds.values(): s.stop()



elif action == 'mode_review':

sounds['flatline'].stop()

sounds['underwater'].set_volume(0.2)


elif action == 'mode_reality':

sounds['underwater'].set_volume(0.0)

sounds['flatline'].stop()

sounds['heartbeat'].play(loops=1, fade_ms=3000)

# å›åˆ°ç°å®ï¼Œåœæ­¢æ‰€æœ‰å›å¿†å£°éŸ³

for s in memory_sounds.values(): s.stop()


# --- å¿ƒè·³æ§åˆ¶ ---

elif action == 'play_heartbeat':

sounds['heartbeat'].play(loops=-1, fade_ms=2000)


elif action == 'stop_heartbeat':

sounds['heartbeat'].stop()



# --- [æ–°å¢] å›å¿†èšç„¦é€»è¾‘ ---

elif action == 'focus_enter':

# çœ‹å‘å›¾ç‰‡ï¼šæ’­æ”¾å£°éŸ³ï¼Œæ¸å…¥ (2ç§’)

img_id = data.get('id')

if img_id in memory_sounds:

# loops=-1 å¾ªç¯æ’­æ”¾ï¼Œfade_ms=2000 æ¸å…¥

memory_sounds[img_id].play(loops=-1, fade_ms=2000)


elif action == 'focus_exit':

# ç§»å¼€è§†çº¿ï¼šå£°éŸ³æ¸å‡ºåœæ­¢ (1.5ç§’)

img_id = data.get('id')

if img_id in memory_sounds:

memory_sounds[img_id].fadeout(3000)



return jsonify({"status": "ok", "action": action})



if __name__ == '__main__':

app.run(host='0.0.0.0', port=5001, ssl_context='adhoc', debug=False)