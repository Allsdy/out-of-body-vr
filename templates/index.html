<!DOCTYPE html>
<html>

<head>
    <title>Mac VR Stream</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
</head>

<body>

    <img id="source" src="/video_feed" crossorigin="anonymous" style="display:none;">

    <canvas id="canvas-tex" width="1280" height="720" style="display:none;"></canvas>

    <script>
        AFRAME.registerComponent('video-canvas', {
            init: function () {
                this.img = document.getElementById('source');
                this.canvas = document.getElementById('canvas-tex');
                this.ctx = this.canvas.getContext('2d');

                // Optimization: Disable alpha transparency for speed
                this.ctx.globalCompositeOperation = 'copy';
                this.ctx.imageSmoothingEnabled = false; // Optional: Makes video sharper/faster but pixelated if zoomed
            },

            tick: function () {
                // REMOVED THE TIME THROTTLE.
                // Now checking every single frame (90 times a second).

                if (this.img.complete && this.img.naturalHeight > 0) {

                    // Draw immediately
                    this.ctx.drawImage(this.img, 0, 0, this.canvas.width, this.canvas.height);

                    // Force A-Frame to update texture
                    let mesh = this.el.getObject3D('mesh');
                    if (mesh && mesh.material.map) {
                        mesh.material.map.needsUpdate = true;
                    }
                }
            }
        });
    </script>

    <a-scene>
        <a-curvedimage video-canvas src="#canvas-tex" height="6.0" radius="3.0" theta-length="140" rotation="0 270 0"
            position="0 1.5 0" scale="-1 1 1" material="shader: flat; side: double;">
        </a-curvedimage>

        <a-entity position="0 1.6 0">
            <a-camera look-controls wasd-controls="false"></a-camera>
        </a-entity>

        <a-sky color="#000"></a-sky>
    </a-scene>
</body>

</html>