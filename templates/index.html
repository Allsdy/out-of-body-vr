<!DOCTYPE html>
<html>

<head>
    <title>Soumatou Experience</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <audio id="snd-heartbeat" src="/static/heartbeat.mp3" loop preload="auto"></audio>
    <audio id="snd-flatline" src="/static/flatline.mp3" preload="auto"></audio>

    <script>
        // 1. VIDEO PAINTER
        AFRAME.registerComponent('video-canvas', {
            init: function () {
                this.img = document.getElementById('source');
                this.canvas = document.getElementById('canvas-tex');
                this.ctx = this.canvas.getContext('2d');
                this.ctx.globalCompositeOperation = 'copy';
            },
            tick: function () {
                if (this.img.complete && this.img.naturalHeight > 0) {
                    this.ctx.drawImage(this.img, 0, 0, this.canvas.width, this.canvas.height);
                    let mesh = this.el.getObject3D('mesh');
                    if (mesh && mesh.material.map) {
                        mesh.material.map.needsUpdate = true;
                    }
                }
            }
        });

        // 2. SOUL TRIGGER & AUDIO
        AFRAME.registerComponent('soul-trigger', {
            init: function () {
                this.heartbeat = document.getElementById('snd-heartbeat');
                this.flatline = document.getElementById('snd-flatline');
                this.isDead = false;

                // Bind 'this' so functions can access component data
                this.startAudio = this.startAudio.bind(this);
                this.detachSoul = this.detachSoul.bind(this);
                this.handleTrigger = this.handleTrigger.bind(this);

                // Listeners
                this.el.sceneEl.addEventListener('enter-vr', this.startAudio);
                this.el.addEventListener('triggerdown', this.handleTrigger);
                this.el.addEventListener('abuttondown', this.detachSoul);
                this.el.addEventListener('xbuttondown', this.detachSoul);
                window.addEventListener('click', this.startAudio);
            },

            startAudio: function () {
                if (!this.isDead && this.heartbeat.paused) {
                    console.log("Starting Heartbeat...");
                    this.heartbeat.play().catch(e => console.log("Audio block:", e));
                }
            },

            handleTrigger: function () {
                this.startAudio(); // Ensure audio starts on first click
            },

            detachSoul: function () {
                if (this.isDead) return;
                this.isDead = true;
                console.log("DEATH TRIGGERED");

                // Audio Swap
                this.heartbeat.pause();
                this.heartbeat.currentTime = 0;
                this.flatline.play();

                // Visual Fade In
                let screen = document.querySelector('#spirit-screen');
                screen.setAttribute('animation', {
                    property: 'material.opacity',
                    from: 0,
                    to: 1,
                    dur: 8000,
                    easing: 'easeInOutSine'
                });
            }
        });
    </script>
</head>

<body>
    <img id="source" src="/video_feed" crossorigin="anonymous" style="display:none;">
    <canvas id="canvas-tex" width="1280" height="720" style="display:none;"></canvas>

    <a-scene>

        <a-curvedimage id="spirit-screen" video-canvas src="#canvas-tex" height="9.0" radius="2.0" theta-length="180"
            rotation="0 270 0" position="0 1.5 0" scale="-1 1 1"
            material="shader: flat; side: double; transparent: true; opacity: 0; depthTest: false">
        </a-curvedimage>

        <a-entity oculus-touch-controls="hand: left" soul-trigger></a-entity>
        <a-entity oculus-touch-controls="hand: right" soul-trigger></a-entity>

        <a-entity position="0 1.6 0">
            <a-camera look-controls wasd-controls="false"></a-camera>
        </a-entity>

    </a-scene>
</body>

</html>